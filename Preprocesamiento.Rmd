---
title: "La población carcelaria en Colombia 1991-2017"
author: "Sergio Solano"
date: "Febrero de 2016"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
autoloads <- c("dplyr", "ggplot2", "Hmisc")
options(defaultPackages = c(getOption("defaultPackages"), autoloads))
```

## Data 

El INPEC publica mensualemente la serie población carcelaria, desde 1991 hasta el mese anterior a la publicación. Esta serie se encuentra separada por situación jurídica (condenados, sindicados) y por genero. 

## Objetivo

El proceso a través del cual las personas pasan de una situación jurídica a otra es conocido, y sin embargo no observado, pues no se publican las series de tiempo que reflejan esta transición (cantidad de personas sentenciadas por mes, cantidad de personas liberadas mes, duración de la condena). 

Este ejercicio de demografía, enmarcado en el estudio de poblaciones pequeñas, presenta la oportunidad de comparar la efectividad de diferentes métodos de proyección.

# Análisis exploratorio

La población carcelaria total entre 1991 y 2017 se ha cuadruplicado, al pasar de 32.036 a 128.125 internos. Aunque la mayoría son hombres la población carcelaria feminina en el mismo periodo ha crecido a una tasa mayor, pues se ha multiplicado por cinco, de 1633 en 1991 a 7800 en 2017.

```{r librerías, echo = FALSE, include=FALSE }
rm(list = ls())
library("magrittr")
library("tidyr")
library("reshape2")
library("ggplot2")
library("plotly")
library("zoo")
library("shiny")
library("curl")
library ("timeSeries")
library ("ggplot2")
library("dplyr")
library("astsa")
library("xts")
library ("vars")

```

```{r carga de datos, echo = FALSE, include=FALSE }
# Carga de archivos base
url <- "https://www.dropbox.com/s/epb2srm6pglyz9w/PPL_SITJUR_ENE17.csv?dl=1"
destfile <- "POB_SITJUR_INP_ENE17.csv"
curl_download(url, destfile)
data = read.csv("POB_SITJUR_INP_ENE17.csv",header = TRUE,sep = ",",stringsAsFactors=FALSE)

```


```{r forma de los datos, echo = FALSE, include=FALSE }

# Carga de archivos base Situación judicial
ppl_sitjur_ene17 <- (data[2:13,2:dim(data)[2]])
ppl_sitjur <- cbind(gather(ppl_sitjur_ene17)[2],rep(c(rep("sindicados",12), rep("condenados",12), rep("total",12)),dim(ppl_sitjur_ene17)[2]/3))
colnames(ppl_sitjur) <- c("valor", "categoria")
ppl_sitjur$valor <- as.numeric(ppl_sitjur$valor)*1000
anio <- sort(rep(seq(1991,1991+dim(ppl_sitjur_ene17)[2]/3-1,by =1),36))
mes <- rep(seq(1,12,1),dim(ppl_sitjur_ene17)[2])
ppl_sitjur <- cbind(ppl_sitjur,anio, mes) 
# ppl_sitjur  %<>% spread(key = "categoria", value = valor) 

ppl_sitjur %<>% mutate (Fecha = as.Date(paste (1,mes,anio, sep = "/"),"%d/%m/%Y")) 
```


```{r gráfica de situación jurídica, echo = FALSE}

ppl_sitjur %>% filter (categoria %in% c("sindicados","condenados","total"), valor >0) %>%  ggplot() + geom_line(aes(x=Fecha,y = valor, colour = categoria),stat = "identity") + ylab("Personas privadas de la libertad")-> grafica 
# ggplotly(grafica)
grafica

```


```{r carga de datos - genero, echo = FALSE, include=FALSE }
# Carga de archivos base
url <- "https://www.dropbox.com/s/95m8oziipdy6ely/PPL_GEN_ENE17.csv?dl=1"
destfile <- "POB_GEN_INP_ENE17.csv"
curl_download(url, destfile)
data = read.csv("POB_GEN_INP_ENE17.csv",header = TRUE,sep = ",",stringsAsFactors=FALSE)

```


```{r forma de los datos - genero, echo = FALSE, include=FALSE }

# Carga de archivos base genero
ppl_gen_ene17 <- (data[2:13,2:dim(data)[2]])
ppl_gen <- cbind(gather(ppl_gen_ene17)[2],rep(c(rep("hombres",12), rep("mujeres",12), rep("total",12)),dim(ppl_sitjur_ene17)[2]/3))
colnames(ppl_gen) <- c("valor", "categoria")
ppl_gen$valor <- as.numeric(ppl_gen$valor)*1000
anio <- sort(rep(seq(1991,1991+dim(ppl_sitjur_ene17)[2]/3-1,by =1),36))
mes <- rep(seq(1,12,1),dim(ppl_sitjur_ene17)[2])
ppl_gen <- cbind(ppl_gen,anio, mes) 

ppl_gen %<>% mutate (Fecha = as.Date(paste (1,mes,anio, sep = "/"),"%d/%m/%Y")) 
```


```{r grafica - genero, echo = FALSE}

ppl_gen %>% filter (categoria %in% c("hombres","mujeres","total"), valor >0) %>%  ggplot() + geom_line(aes(x=Fecha,y = valor, colour = categoria),stat = "identity") + ylab("Personas privadas de la libertad")-> grafica 
# ggplotly(grafica)
 grafica
```

```{r Estimación Población Nacional, include = TRUE, echo = FALSE, warning = FALSE, message=FALSE}


url <- "https://www.dropbox.com/s/54vmiq6tfhor0t1/POB_NAL_DANE.csv?dl=1"
destfile <- "POB_NAL_DAN.csv"
curl_download(url, destfile)

# setwd("/home/sergio/Prisiones") 
data = read.csv("POB_NAL_DAN.csv",header = TRUE,sep = ",",stringsAsFactors=FALSE)

# reordenar columnas por sexo
data %>% spread(Grupo, Total, fill = NA, convert = FALSE) %>% mutate(tasa_hombres = c(log(Hombres[2:length(Hombres)]/Hombres[1:length(Hombres)-1]),1))%>% mutate(tasa_mujeres = c(log(Mujeres[2:length(Mujeres)]/Mujeres[1:length(Mujeres)-1]),1))%>% mutate(Fecha=as.Date(paste("01","06",Año,sep="/"),"%d/%m/%Y"))   -> data2

# Proyectar población a nivel mensual 

ts_pob_nal_hom <- zoo(data2$Hombres,data2$Fecha)  
ts_pob_nal_hom_mon <- na.spline(ts_pob_nal_hom, xout = seq(start(ts_pob_nal_hom),as.Date(as.yearqtr(end(ts_pob_nal_hom))+ 3/4) , by = "month"), method = "hyman")

ts_pob_nal_muj <- zoo(data2$Mujeres,data2$Fecha)  
ts_pob_nal_muj_mon <- na.spline(ts_pob_nal_muj, xout = seq(start(ts_pob_nal_muj),as.Date(as.yearqtr(end(ts_pob_nal_muj))+ 3/4) , by = "month"), method = "fmm")
                                
pob_nal_est <- cbind(seq(as.Date("1985/6/1"), as.Date("2021/1/1"), "months"), as.data.frame.ts(ts_pob_nal_hom_mon),as.data.frame.ts(ts_pob_nal_muj_mon)) 

colnames(pob_nal_est) <- c("Fecha","hombres_nac","mujeres_nac")

pob_nal_est %<>% mutate (total_nac = hombres_nac + mujeres_nac)


```
El incremento en la población carcelaria podría tomarse como un efecto del crecimiento de la población colombiana. Para validar este supuesto calculamos la tasa de encarcelamiento, que mide la cantidad de personas encarceladas por cada cien mil habitantes. Este indicador pasó de 92 personas por cada cien mil habitantes en enero de 1991 a 242 en enero de 2016. Tal incremento se puede ver tanto en hombres como en mujeres.

```{r tasa de encarcelamiento, echo = FALSE,  warning = FALSE, message=FALSE}

ppl_gen  %<>% spread(key = "categoria", value = valor) 

ppl_tasa <- left_join(pob_nal_est,ppl_gen, by = "Fecha") %>% mutate (tasa_hombres = hombres/hombres_nac * 100000, tasa_mujeres = mujeres/mujeres_nac * 100000, tasa_total = total/total_nac*100000) 

ppl_tasa %>% ggplot() + geom_line(aes(x=Fecha,y=tasa_hombres,colour="Hombres")) +geom_line(aes(x=Fecha,y=tasa_mujeres,colour="Mujeres"))+geom_line(aes(x=Fecha,y=tasa_total,colour="Total")) + expand_limits(y=0) + ylab("Tasa de encarcelamiento")-> tasas_encarcelamiento
# ggplotly (tasas_encarcelamiento)
tasas_encarcelamiento
```

La tasa de encarcelamiento ha crecido de forma exponencial, tanto en hombres como en mujres, y  se puede ver en la gráfica siguiente.

```{r tasa de encarcelamiento log, echo = FALSE,  warning = FALSE, message=FALSE}
ppl_tasa %>% ggplot() + geom_line(aes(x=Fecha,y=tasa_hombres,colour="Hombres")) +geom_line(aes(x=Fecha,y=tasa_mujeres,colour="Mujeres"))+geom_line(aes(x=Fecha,y=tasa_total,colour="Total")) + expand_limits(y=0) + scale_y_log10 (breaks = c(10,50,100,200,400)) + ylab("Tasa de encarcelamiento")-> tasas_encarcelamiento_log
# ggplotly (tasas_encarcelamiento_log)

tasas_encarcelamiento_log

```

## Crecimiento de la Población Privada de la Libertad (PPL)

Una primera aproximación al análisis de la población carcelaria, se podría realizar al separar los componentes estacionales, de tendencia y aleatorios de la serie de tiempo. No obstante, es posible inferir que la variabilidad de la serie no es constante. Por esta razón resultaría pertinente analizar la tasa de crecimiento de la población de mes a mes. Una técnica comunmente usada es trabajar con la difencia de los logaritmos de la población, que para variaciones cercanas a cero, se aproxima a la tasa de crecimiento. 

```{r tasa crecimiento, echo = FALSE,  warning = FALSE, message=FALSE}

MPPtimeseries <- ts(ppl_gen$total, frequency=12, start=c(1991,1))

autoplot(as.zoo(diff(log(MPPtimeseries))), geom = "line") + ylab("tasa de crecimiento- PPL total") + xlab("Periodo") -> graf_crecimiento
graf_crecimiento
# ggplotly(graf_crecimiento)

```


```{r tasa de crecimiento descompuesto, echo = FALSE,  warning = FALSE, message=FALSE }
DeltaMPP <- decompose(diff(log(MPPtimeseries)))

tendencia <- as.zoo(DeltaMPP$trend)
aleatorio <- as.zoo(DeltaMPP$random)
estacional <- as.zoo(DeltaMPP$seasonal)

autoplot(merge(tendencia,estacional, aleatorio), geom = "line") + ylab("tasa de crecimiento - descomposición") + xlab("Periodo") -> graf_tendencia
graf_tendencia       
# ggplotly(graf_tendencia)

```

Crecimiento de la población privada de la libertad masculida

```{r tasa crecimiento masculina, echo = FALSE,  warning = FALSE, message=FALSE}

MPPtimeseries <- ts(ppl_gen$hombres, frequency=12, start=c(1991,1))

autoplot(as.zoo(diff(log(MPPtimeseries))), geom = "line") + ylab("tasa de crecimiento- PPL masculina") + xlab("Periodo") + theme(aspect.ratio=1/2) -> graf_crecimiento

graf_crecimiento
# ggplotly(graf_crecimiento)

```

```{r tasa de crecimiento descompuesta - masculina, echo = FALSE,  warning = FALSE, message=FALSE }
DeltaMPP <- decompose(diff(log(MPPtimeseries)))

tendencia <- as.zoo(DeltaMPP$trend)
aleatorio <- as.zoo(DeltaMPP$random)
estacional <- as.zoo(DeltaMPP$seasonal)

autoplot(merge(tendencia,estacional, aleatorio), geom = "line") + ylab("tasa de crecimiento - descomposición") + xlab("Periodo") -> graf_tendencia
graf_tendencia       
# ggplotly(graf_tendencia)

```

Crecimiento de la población privada de la libertad femenina 

```{r tasa crecimiento femenina, echo = FALSE,  warning = FALSE, message=FALSE}

MPPtimeseries <- ts(ppl_gen$mujeres, frequency=12, start=c(1991,1))

autoplot(as.zoo(diff(log(MPPtimeseries))), geom = "line") + ylab("tasa de crecimiento- PPL femenina") + xlab("Periodo") + theme(aspect.ratio=1/2) -> graf_crecimiento
graf_crecimiento
# ggplotly(graf_crecimiento)

```

```{r tasa de crecimiento descompuesta - femenina, echo = FALSE,  warning = FALSE, message=FALSE }

DeltaMPP <- decompose(diff(log(MPPtimeseries)))

tendencia <- as.zoo(DeltaMPP$trend)
aleatorio <- as.zoo(DeltaMPP$random)
estacional <- as.zoo(DeltaMPP$seasonal)

autoplot(merge(tendencia,estacional, aleatorio), geom = "line") + ylab("tasa de crecimiento - descomposición") + xlab("Periodo") -> graf_tendencia

graf_tendencia     
# ggplotly(graf_tendencia)

```

# Procesos ARIMA

Los procesos ARMA son procesos aleatorios de la forma 

<center> $Y_t = \gamma Y_{t-1} + \gamma_2 Y_{t-2} ... + \epsilon + \theta_1\epsilon_{t-1}$<center>

Aunque el termino $\epsilon$ no tiene necesariamente una distribución normal, por el resto de documento se asumirá una distribución normal con media $\mu$ y varianza $\sigma²$, a menos que se especifique lo contrario. 

Los procesos ARIMA resultan al considerar una serie de la forma: 

<center> $Y_t = \alpha +  Y_{t-1}$ <center>

Tal que el proceso $Y_t - Y_{t-1}$ es un proceso ARMA.

Una primera aproximación a la proyección de poblaciones carcelarias será validar si es posible modelar el proceso como un proceso ARIMA. Con este propósito presentamos las funciones de autocorrelación y autocorrelación parcial de la población total.


```{r ACF, echo = FALSE}
ppl_sitjur %>% filter(categoria == "total", !(is.na(valor))) -> ppl_total
ppl_total <- ppl_total$valor
ts_total <- ts(ppl_total, start = 1991, frequency = 12)
# plot(diff(diff(ts_total), lag = 12))
# acf2(diff(diff(ts_total), lag = 12), max.lag = 60, details = FALSE)
plot (acf(diff(diff(ts_total), lag = 12), lag.max = 60, plot = FALSE),main = "AFC Variación de la población total desestacionalizado")
plot(pacf(diff(diff(ts_total), lag = 12), lag.max = 60, plot = FALSE),main = "PAFC Variación de la población total desestacionalizado")

```

Las funciones de autocorrelación y correlación cruzada, de $Y_t - Y_{t - 1} $ muestran: 

* La función de autocorrelación decae, y la función de autocorrelación parcial también decae, sugiriendo un ARMA. 
* La función de autocorrelación se encuetra sobre las dos desviaciones estándar, sugiriendo que son significativas.
* La función de autocorrelación tiene un único pico en el periodo doce, la función de autocorrelación parcial decae lentamente, sugiriendo un MA(1)

En estas condiciones podemos ajustar un ARIMA (1,1,1,0,0,1)

```{r estima_arima, echo = FALSE, include = TRUE}
arima_total <- sarima(ts_total,1,1,1,0,0,1, S = 12, details = FALSE)
```

Todos los parámetros del modelo tienen un p_value que sugiere que son significativos, excepto por la constante. Sin embargo, la autocorrelación del periodo dos sugiere que podemos estimar un ARIMA (1,1,1,0,0,2)

```{r estima_arima_2, echo = FALSE, include = TRUE}
sarima_total_2 <- sarima(ts_total,1,1,1,0,0,2, S = 12, details = FALSE)
```

El nuevo término SA2 resulta siginicativo y presenta criterios de información de valor más pequeño, lo que implica que el modelo ARIMA (1,1,1,0,0,2) resulta más apropiado que el modelo ARIMA (1,1,1,0,0,1). Proyecciones de la población carcelaria del modelo ARIMA (1,1,1,0,0,2) se presentan a continuación: 

```{r pry_arima_2, echo = FALSE, include = TRUE}
forecast <- sarima.for(ts_total,n.ahead = 36, 1,1,1,0,0,2, S = 12)
```

```{r ACF_sin, echo = FALSE, include = FALSE}
ppl_sitjur %>% filter(categoria == "sindicados", !(is.na(valor))) -> ppl_sin
ppl_sin <- ppl_sin$valor
ts_sin <- ts(ppl_sin, start = 1991, frequency = 12)
# plot(diff(diff(ts_total), lag = 12))
# acf2(diff(diff(ts_total), lag = 12), max.lag = 60, details = FALSE)
plot (acf(diff(diff(ts_sin), lag = 12), lag.max = 60, plot = FALSE),main = "AFC Variación de la población sindicada desestacionalizado")
plot(pacf(diff(diff(ts_sin), lag = 12), lag.max = 60, plot = FALSE),main = "PAFC Variación de la población sindicada desestacionalizado")
```

Se presenta proyección de la población sindicada: 

```{r pry_arima_sin, echo = FALSE, include = TRUE}
forecast <- sarima.for(ts_sin,n.ahead = 36, 1,1,1,0,0,1, S = 12)
```

```{r ACF_con, echo = FALSE, include = FALSE}
ppl_sitjur %>% filter(categoria == "condenados", !(is.na(valor))) -> ppl_con
ppl_con <- ppl_con$valor
ts_con <- ts(ppl_con, start = 1991, frequency = 12)
# plot(diff(diff(ts_total), lag = 12))
# acf2(diff(diff(ts_total), lag = 12), max.lag = 60, details = FALSE)
plot (acf(diff(diff(ts_con), lag = 12), lag.max = 60, plot = FALSE),main = "AFC Variación de la población condenada desestacionalizado")
plot(pacf(diff(diff(ts_con), lag = 12), lag.max = 60, plot = FALSE),main = "PAFC Variación de la población condenada desestacionalizado")
```

Se presenta proyección de la población condenada: 

```{r pry_arima_con, echo = FALSE, include = TRUE}
forectast <- sarima.for(ts_con,n.ahead = 36, 1,1,1,0,0,1, S = 12)
```


## Limitaciones de los modelos ARIMA en proyección de poblaciones carcelarias

Aunque es posible seguir analizando modelos ARIMA hasta encontrar el que presente mejores criterios de información, detendremos el analisis en este punto, para centrarnos en las limitaciones del enfoque. 

1. La serie de población carcelarias incluye, por lo menos,  dos series de tiempo con un comportamiento diferente: La población condenada y la población sindicada. Estos procesos, son en principio procesos autoregresivos, donde además se podría intuir el error no es independiente (como en la población total).
2. Los shocks en el sistema no son necesariamente estables en el tiempo. Las variaciones en los parámetros del modelo dependen de variables exógenas, como la cantidad de personas que ingresan al sistema y la dureza de las penas.
3. Los intervalos de confianza crecen rápidamente pues el modelo se ve afectado fuertemente por cambios en el nivel.
4. Puesto que el modelo supone unos parámetros fijos no da cuenta de la influencia de variables exógenas en el crecimiento de la población carcelaria.

#  MODELOS VAR: 

```{r var, echo = TRUE, include = TRUE}

ts_sincon <- cbind (diff(ts_sin), diff(ts_con))
VARselect(ts_sincon, lag.max=9, type="const")
ts_sincon_mod <- VAR(ts_sincon,p = 1)
forecast_var <- predict(ts_sincon_mod, n.ahead = 60)
ts_sincon_mod
forecast_var

```


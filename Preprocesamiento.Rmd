---
title: "La población carcelaria en Colombia 1991-2017"
author: "Sergio Solano"
date: "Febrero de 2016"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
autoloads <- c("dplyr", "ggplot2", "Hmisc")
options(defaultPackages = c(getOption("defaultPackages"), autoloads))
```

## Data 

El INPEC publica mensualemente la serie población carcelaria, desde 1991 hasta el mese anterior a la publicación. Esta serie se encuentra separada por situación jurídica (condenados, sindicados) y por genero. 

## Objetivo

El proceso a través del cual las personas pasan de una situación jurídica a otra es conocido, y sin embargo no observado, pues no se publican las series de tiempo que reflejan esta transición (cantidad de personas sentenciadas por mes, cantidad de personas liberadas mes, duración de la condena). 

Este ejercicio de demografía, enmarcado en el estudio de poblaciones pequeñas, presenta la oportunidad de comparar la efectividad de diferentes métodos de proyección.

# Análisis exploratorio

La población carcelaria total entre 1991 y 2017 se ha cuadruplicado, al pasar de 32.036 a 128.125 internos. Aunque la mayoría son hombres la población carcelaria feminina en el mismo periodo ha crecido a una tasa mayor, pues se ha multiplicado por cinco, de 1633 en 1991 a 7800 en 2017.

```{r librerías, echo = FALSE, include=FALSE }
rm(list = ls())
library("magrittr")
library("tidyr")
library("reshape2")
library("ggplot2")
library("plotly")
library("zoo")
library("shiny")
library("curl")
library ("timeSeries")
library ("ggplot2")
library("dplyr")

```

```{r carga de datos, echo = FALSE, include=FALSE }
# Carga de archivos base
url <- "https://www.dropbox.com/s/epb2srm6pglyz9w/PPL_SITJUR_ENE17.csv?dl=1"
destfile <- "POB_SITJUR_INP_ENE17.csv"
curl_download(url, destfile)
data = read.csv("POB_SITJUR_INP_ENE17.csv",header = TRUE,sep = ",",stringsAsFactors=FALSE)

```


```{r forma de los datos, echo = FALSE, include=FALSE }

# Carga de archivos base Situación judicial
ppl_sitjur_ene17 <- (data[2:13,2:dim(data)[2]])
ppl_sitjur <- cbind(gather(ppl_sitjur_ene17)[2],rep(c(rep("sindicados",12), rep("condenados",12), rep("total",12)),dim(ppl_sitjur_ene17)[2]/3))
colnames(ppl_sitjur) <- c("valor", "categoria")
ppl_sitjur$valor <- as.numeric(ppl_sitjur$valor)*1000
anio <- sort(rep(seq(1991,1991+dim(ppl_sitjur_ene17)[2]/3-1,by =1),36))
mes <- rep(seq(1,12,1),dim(ppl_sitjur_ene17)[2])
ppl_sitjur <- cbind(ppl_sitjur,anio, mes) 
# ppl_sitjur  %<>% spread(key = "categoria", value = valor) 

ppl_sitjur %<>% mutate (Fecha = as.Date(paste (1,mes,anio, sep = "/"),"%d/%m/%Y")) 
```


```{r gráfica de situación jurídica, echo = FALSE}

ppl_sitjur %>% filter (categoria %in% c("sindicados","condenados","total"), valor >0) %>%  ggplot() + geom_line(aes(x=Fecha,y = valor, colour = categoria),stat = "identity") + ylab("Personas privadas de la libertad")-> grafica 
# ggplotly(grafica)
grafica

```


```{r carga de datos - genero, echo = FALSE, include=FALSE }
# Carga de archivos base
url <- "https://www.dropbox.com/s/95m8oziipdy6ely/PPL_GEN_ENE17.csv?dl=1"
destfile <- "POB_GEN_INP_ENE17.csv"
curl_download(url, destfile)
data = read.csv("POB_GEN_INP_ENE17.csv",header = TRUE,sep = ",",stringsAsFactors=FALSE)

```


```{r forma de los datos - genero, echo = FALSE, include=FALSE }

# Carga de archivos base genero
ppl_gen_ene17 <- (data[2:13,2:dim(data)[2]])
ppl_gen <- cbind(gather(ppl_gen_ene17)[2],rep(c(rep("hombres",12), rep("mujeres",12), rep("total",12)),dim(ppl_sitjur_ene17)[2]/3))
colnames(ppl_gen) <- c("valor", "categoria")
ppl_gen$valor <- as.numeric(ppl_gen$valor)*1000
anio <- sort(rep(seq(1991,1991+dim(ppl_sitjur_ene17)[2]/3-1,by =1),36))
mes <- rep(seq(1,12,1),dim(ppl_sitjur_ene17)[2])
ppl_gen <- cbind(ppl_gen,anio, mes) 

ppl_gen %<>% mutate (Fecha = as.Date(paste (1,mes,anio, sep = "/"),"%d/%m/%Y")) 
```


```{r grafica - genero, echo = FALSE}

ppl_gen %>% filter (categoria %in% c("hombres","mujeres","total"), valor >0) %>%  ggplot() + geom_line(aes(x=Fecha,y = valor, colour = categoria),stat = "identity") + ylab("Personas privadas de la libertad")-> grafica 
# ggplotly(grafica)
 grafica
```

```{r Estimación Población Nacional, include = TRUE, echo = FALSE, warning = FALSE, message=FALSE}


url <- "https://www.dropbox.com/s/54vmiq6tfhor0t1/POB_NAL_DANE.csv?dl=1"
destfile <- "POB_NAL_DAN.csv"
curl_download(url, destfile)

# setwd("/home/sergio/Prisiones") 
data = read.csv("POB_NAL_DAN.csv",header = TRUE,sep = ",",stringsAsFactors=FALSE)

# reordenar columnas por sexo
data %>% spread(Grupo, Total, fill = NA, convert = FALSE) %>% mutate(tasa_hombres = c(log(Hombres[2:length(Hombres)]/Hombres[1:length(Hombres)-1]),1))%>% mutate(tasa_mujeres = c(log(Mujeres[2:length(Mujeres)]/Mujeres[1:length(Mujeres)-1]),1))%>% mutate(Fecha=as.Date(paste("01","06",Año,sep="/"),"%d/%m/%Y"))   -> data2

# Proyectar población a nivel mensual 

ts_pob_nal_hom <- zoo(data2$Hombres,data2$Fecha)  
ts_pob_nal_hom_mon <- na.spline(ts_pob_nal_hom, xout = seq(start(ts_pob_nal_hom),as.Date(as.yearqtr(end(ts_pob_nal_hom))+ 3/4) , by = "month"), method = "hyman")

ts_pob_nal_muj <- zoo(data2$Mujeres,data2$Fecha)  
ts_pob_nal_muj_mon <- na.spline(ts_pob_nal_muj, xout = seq(start(ts_pob_nal_muj),as.Date(as.yearqtr(end(ts_pob_nal_muj))+ 3/4) , by = "month"), method = "fmm")
                                
pob_nal_est <- cbind(seq(as.Date("1985/6/1"), as.Date("2021/1/1"), "months"), as.data.frame.ts(ts_pob_nal_hom_mon),as.data.frame.ts(ts_pob_nal_muj_mon)) 

colnames(pob_nal_est) <- c("Fecha","hombres_nac","mujeres_nac")

pob_nal_est %<>% mutate (total_nac = hombres_nac + mujeres_nac)


```
El incremento en la población carcelaria podría tomarse como un efecto del crecimiento de la población colombiana. Para validar este supuesto calculamos la tasa de encarcelamiento, que mide la cantidad de personas encarceladas por cada cien mil habitantes. Este indicador pasó de 92 personas por cada cien mil habitantes en enero de 1991 a 242 en enero de 2016. Tal incremento se puede ver tanto en hombres como en mujeres.

```{r tasa de encarcelamiento, echo = FALSE,  warning = FALSE, message=FALSE}

ppl_gen  %<>% spread(key = "categoria", value = valor) 

ppl_tasa <- left_join(pob_nal_est,ppl_gen, by = "Fecha") %>% mutate (tasa_hombres = hombres/hombres_nac * 100000, tasa_mujeres = mujeres/mujeres_nac * 100000, tasa_total = total/total_nac*100000) 

ppl_tasa %>% ggplot() + geom_line(aes(x=Fecha,y=tasa_hombres,colour="Hombres")) +geom_line(aes(x=Fecha,y=tasa_mujeres,colour="Mujeres"))+geom_line(aes(x=Fecha,y=tasa_total,colour="Total")) + expand_limits(y=0) + ylab("Tasa de encarcelamiento")-> tasas_encarcelamiento
# ggplotly (tasas_encarcelamiento)
tasas_encarcelamiento
```

La tasa de encarcelamiento ha crecido de forma exponencial, tanto en hombres como en mujres, y  se puede ver en la gráfica siguiente.

```{r tasa de encarcelamiento log, echo = FALSE,  warning = FALSE, message=FALSE}
ppl_tasa %>% ggplot() + geom_line(aes(x=Fecha,y=tasa_hombres,colour="Hombres")) +geom_line(aes(x=Fecha,y=tasa_mujeres,colour="Mujeres"))+geom_line(aes(x=Fecha,y=tasa_total,colour="Total")) + expand_limits(y=0) + scale_y_log10 (breaks = c(10,50,100,200,400)) + ylab("Tasa de encarcelamiento")-> tasas_encarcelamiento_log
# ggplotly (tasas_encarcelamiento_log)
tasas_encarcelamiento_log

```

## Crecimiento de la Población Privada de la Libertad (PPL)

Una primera aproximación al análisis de la población carcelaria, se podría realizar al separar los componentes estacionales, de tendencia y aleatorios de la serie de tiempo. No obstante, es posible inferir que la variabilidad de la serie no es constante. Por esta razón resultaría pertinente analizar la tasa de crecimiento de la población de mes a mes. Una técnica comunmente usada es trabajar con la difencia de los logaritmos de la población, que para variaciones cercanas a cero, se aproxima a la tasa de crecimiento. 

```{r tasa crecimiento, echo = FALSE,  warning = FALSE, message=FALSE}

MPPtimeseries <- ts(ppl_gen$total, frequency=12, start=c(1991,1))

autoplot(as.zoo(diff(log(MPPtimeseries))), geom = "line") + ylab("tasa de crecimiento- PPL total") + xlab("Periodo") -> graf_crecimiento

graf_crecimiento

```


```{r tasa de crecimiento descompuesto, echo = FALSE,  warning = FALSE, message=FALSE }
DeltaMPP <- decompose(diff(log(MPPtimeseries)))

tendencia <- as.zoo(DeltaMPP$trend)
aleatorio <- as.zoo(DeltaMPP$random)
estacional <- as.zoo(DeltaMPP$seasonal)

autoplot(merge(tendencia,estacional, aleatorio), geom = "line") + ylab("tasa de crecimiento - descomposición") + xlab("Periodo") -> graf_tendencia
       
graf_tendencia

```

Crecimiento de la población privada de la libertad masculida

```{r tasa crecimiento masculina, echo = FALSE,  warning = FALSE, message=FALSE}

MPPtimeseries <- ts(ppl_gen$hombres, frequency=12, start=c(1991,1))

autoplot(as.zoo(diff(log(MPPtimeseries))), geom = "line") + ylab("tasa de crecimiento- PPL masculina") + xlab("Periodo") + theme(aspect.ratio=1/2) -> graf_crecimiento

graf_crecimiento

```

```{r tasa de crecimiento descompuesta - masculina, echo = FALSE,  warning = FALSE, message=FALSE }
DeltaMPP <- decompose(diff(log(MPPtimeseries)))

tendencia <- as.zoo(DeltaMPP$trend)
aleatorio <- as.zoo(DeltaMPP$random)
estacional <- as.zoo(DeltaMPP$seasonal)

autoplot(merge(tendencia,estacional, aleatorio), geom = "line") + ylab("tasa de crecimiento - descomposición") + xlab("Periodo") -> graf_tendencia
       
graf_tendencia

```


Crecimiento de la población privada de la libertad femenina 


```{r tasa crecimiento femenina, echo = FALSE,  warning = FALSE, message=FALSE}

MPPtimeseries <- ts(ppl_gen$mujeres, frequency=12, start=c(1991,1))

autoplot(as.zoo(diff(log(MPPtimeseries))), geom = "line") + ylab("tasa de crecimiento- PPL femenina") + xlab("Periodo") + theme(aspect.ratio=1/2) -> graf_crecimiento

graf_crecimiento

```

```{r tasa de crecimiento descompuesta - femenina, echo = FALSE,  warning = FALSE, message=FALSE }

DeltaMPP <- decompose(diff(log(MPPtimeseries)))

tendencia <- as.zoo(DeltaMPP$trend)
aleatorio <- as.zoo(DeltaMPP$random)
estacional <- as.zoo(DeltaMPP$seasonal)

autoplot(merge(tendencia,estacional, aleatorio), geom = "line") + ylab("tasa de crecimiento - descomposición") + xlab("Periodo") -> graf_tendencia
       
graf_tendencia

```

```{r, echo=FALSE, include = FALSE}
# # setwd("/home/sergio/Prisiones") 
# # rm(list=ls())
# data = read.csv("POB_SIT.csv",header = FALSE,sep = ",",stringsAsFactors=FALSE)
#  
# POB = as.integer(c(unlist(data[2:13,2:dim(data)[2]])))
#  
# SIN = c(rep(c(rep(0,12),rep(1,12),rep(2,12)),900/36))
#  
# POB_SIN = cbind(POB,SIN)
#  
# SIND = subset(POB_SIN,POB_SIN[,"SIN"]==0)
#  
#  
# MPP1 = subset(POB_SIN,POB_SIN[,"SIN"]==0)
# MPP = MPP1[76:296,"POB"]
# 
# ##### SERIES DE TIEMPO
# #MPP = Male Prison Population
# 
# MPPtimeseries <- ts(MPP, frequency=12, start=c(1991,1))
# 
# logMMPtimeseries <- log(MPPtimeseries)
# 
# plot.ts(diff(logMMPtimeseries))
# plot(DeltaMPP) 
# 
# # ggplot(DeltaMPP)
# 
# write.csv(DeltaMPP$trend, file = 'sindicados.txt', row.names = TRUE)
# 
# # Crecimiento promedio
# mean(DeltaMPP$trend,na.rm = TRUE)*100
# 
# ####### CONDENADOS 
# MPP1 = subset(POB_SIN,POB_SIN[,"SIN"]==1)
# MPP = MPP1[76:296,"POB"]
# 
# ##### SERIES DE TIEMPO
# #MPP = Male Prison Population
# 
# MPPtimeseries <- ts(MPP, frequency=12, start=c(1991,1))
# 
# logMMPtimeseries <- log(MPPtimeseries)
# 
# plot.ts(diff(logMMPtimeseries))
# 
# #ggplot(yt.views, aes(Date, Views)) + geom_line() +
# #  scale_x_date(format = "%b-%Y") + xlab("") + ylab("Daily Views")
# 
# DeltaMPP = decompose(diff(logMMPtimeseries))
# plot(DeltaMPP) 
# # ggplot(DeltaMPP)
# write.csv(DeltaMPP$trend, file = 'condenados.txt', row.names = TRUE)
# 
# # Crecimiento promedio
# mean(DeltaMPP$trend,na.rm = TRUE)*100
# 
# ####### TOTAL 
# MPP1 = subset(POB_SIN,POB_SIN[,"SIN"]==2)
# MPP = MPP1[76:296,"POB"]
# 
# ##### SERIES DE TIEMPO
# #MPP = Male Prison Population
# 
# MPPtimeseries <- ts(MPP, frequency=12, start=c(1991,1))
# 
# logMMPtimeseries <- log(MPPtimeseries)
# 
# plot.ts(diff(logMMPtimeseries))
# DeltaMPP = decompose(diff(logMMPtimeseries))
# plot(DeltaMPP) 
# # ggplot(DeltaMPP)
# write.csv(DeltaMPP$trend, file = 'condenados.txt', row.names = TRUE)
# 
# # Crecimiento promedio
# mean(DeltaMPP$trend,na.rm = TRUE)*100
```

